name: Documentation & Architecture Check

on:
  # Run on schedule (weekly)
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9:00 AM UTC
  
  # Allow manual trigger
  workflow_dispatch:
  
  # Run on PR to main
  pull_request:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'README.md'
      - 'docs/**'

jobs:
  documentation-check:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Check for circular dependencies
      run: npm run lint
      continue-on-error: true
      id: circular-check
    
    - name: Generate dependency graph
      run: |
        npm install -g madge
        madge --circular src/ > circular-deps.txt || true
        madge --image deps-graph.svg src/ || true
    
    - name: Check documentation freshness
      id: doc-check
      run: |
        # Check if architecture section exists in README
        if ! grep -q "## 🏗️ Architecture" README.md; then
          echo "::warning::Architecture section missing in README.md"
          echo "needs_update=true" >> $GITHUB_OUTPUT
        fi
        
        # Check if directory structure is up to date
        ACTUAL_STRUCTURE=$(find src -type f -name "*.ts" | sort)
        if ! grep -q "config-manager.ts" README.md; then
          echo "::warning::Directory structure in README might be outdated"
          echo "needs_update=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Create or update documentation issue
      if: steps.doc-check.outputs.needs_update == 'true' || steps.circular-check.outcome == 'failure'
      uses: actions/github-script@v7
      with:
        script: |
          const title = '📚 [Scheduled] Documentation & Architecture Update Needed';
          const body = `## 📋 Documentation Check Results
          
          This is an automated check that runs weekly to ensure documentation stays current.
          
          ### Checks Performed:
          - ✅ Circular dependency detection
          - ✅ Architecture documentation presence
          - ✅ Directory structure accuracy
          
          ### Issues Found:
          ${steps.circular-check.outcome === 'failure' ? '- ⚠️ Circular dependencies detected' : ''}
          ${steps.doc-check.outputs.needs_update === 'true' ? '- ⚠️ Documentation needs updating' : ''}
          
          ### Required Actions:
          1. Review and update README.md architecture section
          2. Verify directory structure documentation
          3. Update dependency diagrams if needed
          4. Fix any circular dependencies found
          
          ### Files to Update:
          - [ ] README.md - Architecture section
          - [ ] README.md - Directory structure
          - [ ] docs/architecture.md (if exists)
          - [ ] Fix circular dependencies (if any)
          
          ---
          *This issue was automatically created by the documentation check workflow.*
          *Run date: ${new Date().toISOString()}*
          `;
          
          // Check if issue already exists
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'documentation,automated'
          });
          
          const existingIssue = issues.data.find(issue => 
            issue.title.includes('[Scheduled] Documentation')
          );
          
          if (existingIssue) {
            // Update existing issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existingIssue.number,
              body: body
            });
            
            // Add a comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existingIssue.number,
              body: '🔄 Documentation check ran again. Please review the updated requirements above.'
            });
          } else {
            // Create new issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['documentation', 'automated', 'maintenance']
            });
          }
    
    - name: Upload dependency graph
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: dependency-analysis
        path: |
          circular-deps.txt
          deps-graph.svg
        retention-days: 30
