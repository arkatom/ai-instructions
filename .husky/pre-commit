#!/usr/bin/env sh

# ===== ãƒã‚¤ãƒ‘ã‚¹é˜²æ­¢ã‚·ã‚¹ãƒ†ãƒ  =====
# ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯çµ¶å¯¾ã«å‰Šé™¤ãƒ»å¤‰æ›´ã—ãªã„ã“ã¨

# ç’°å¢ƒå¤‰æ•°ã«ã‚ˆã‚‹ãƒã‚¤ãƒ‘ã‚¹è©¦è¡Œã‚’æ¤œå‡º
if [ -n "$SKIP_HOOKS" ] || [ -n "$NO_VERIFY" ] || [ -n "$BYPASS_HOOKS" ]; then
  echo "ğŸš¨ CRITICAL ERROR: Hook bypass attempt detected!"
  echo "âŒ Environment variables that bypass hooks are not allowed."
  echo "ğŸ“– Please read: docs/BYPASS_POLICY.md"
  echo ""
  echo "If this is truly an emergency:"
  echo "1. Create a bypass request issue: gh issue create --title 'Bypass Request'"
  echo "2. Get 2+ approvals from senior developers"
  echo "3. Use the approved bypass procedure with audit logging"
  
  # ãƒã‚¤ãƒ‘ã‚¹è©¦è¡Œã‚’è¨˜éŒ²
  echo "$(date -u +"%Y-%m-%dT%H:%M:%SZ"): Bypass attempt by $(git config user.name || whoami)" >> .github/bypass-attempts.log
  
  # GitHub Issueã‚’è‡ªå‹•ä½œæˆï¼ˆå¯èƒ½ãªå ´åˆï¼‰
  if command -v gh &> /dev/null; then
    gh issue create \
      --title "âš ï¸ Bypass Attempt Detected: $(git config user.name || whoami)" \
      --body "Attempted to bypass pre-commit hooks at $(date)" \
      --label "security,bypass-attempt" 2>/dev/null || true
  fi
  
  exit 1
fi

# ãƒ•ãƒƒã‚¯è‡ªä½“ãŒæ”¹ç«„ã•ã‚Œã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
HOOK_HASH="$(sha256sum "$0" 2>/dev/null | cut -d' ' -f1)"
EXPECTED_HASH_FILE=".github/hooks-integrity.sha256"

if [ -f "$EXPECTED_HASH_FILE" ]; then
  EXPECTED_HASH="$(grep pre-commit "$EXPECTED_HASH_FILE" 2>/dev/null | cut -d' ' -f2)"
  if [ -n "$EXPECTED_HASH" ] && [ "$HOOK_HASH" != "$EXPECTED_HASH" ]; then
    echo "ğŸš¨ SECURITY ALERT: Pre-commit hook has been tampered with!"
    echo "Expected: $EXPECTED_HASH"
    echo "Actual: $HOOK_HASH"
    echo "Please restore the original hook from version control."
    exit 1
  fi
fi

# ===== è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ =====

# æ–‡å­—è‰²å®šç¾©
RED="\033[1;31m"
GREEN="\033[1;32m"
CYAN="\033[1;36m"
RESET="\033[0m"

# Get current username
CURRENT_USER=$(gh api user 2>/dev/null | grep login | cut -d'"' -f4 || echo "User")

echo "${RED}âš ï¸ Important warning from ${CURRENT_USER} âš ï¸${RESET}"
echo "${RED}============================================${RESET}"
echo "${RED}Performs a pre-commit check. If you fail here,${RESET}"
echo "${RED}you must fix the issues before committing (MUST).${RESET}"
echo "${RED}\"--no-verify\" option MUST NOT BE USED. I AM WATCHING YOU.${RESET}"
echo "${RED}Any inappropriate response will UNDERMINE your TRUST and VALUE.${RESET}"
echo "${RED}============================================${RESET}"

# ===== å“è³ªãƒã‚§ãƒƒã‚¯ =====

# TypeScript compile check (silent on success)
echo "ğŸ” TypeScript check..."
if ! npm run build > /dev/null 2>&1; then
  echo "âŒ TypeScript compilation failed"
  npm run build
  
  # å¤±æ•—ã‚’è¨˜éŒ²
  echo "$(date): TypeScript check failed" >> .github/quality-failures.log
  exit 1
fi
echo "âœ… TypeScript OK"

# Lint check (MUST PASS - no failures allowed)
echo "ğŸ” Lint check..."
if npm run lint > /dev/null 2>&1; then
  echo "âœ… Lint OK"
else
  echo "âŒ Lint failed - blocking commit:"
  npm run lint  # Show errors
  
  # å¤±æ•—ã‚’è¨˜éŒ²
  echo "$(date): Lint check failed" >> .github/quality-failures.log
  exit 1
fi

# Test check (MUST PASS - no failures allowed)
echo "ğŸ§ª Running tests..."
if ! npm test > /dev/null 2>&1; then
  echo "âŒ Tests failed - blocking commit:"
  npm test | grep -E "(FAIL|failed|Test Suites:)" || npm test
  
  # å¤±æ•—ã‚’è¨˜éŒ²
  echo "$(date): Test check failed" >> .github/quality-failures.log
  exit 1
fi
echo "âœ… All tests passed"

# ===== æœ€çµ‚ãƒã‚§ãƒƒã‚¯ =====

# ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒã‚§ãƒƒã‚¯ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
if [ -f "coverage/coverage-summary.json" ]; then
  COVERAGE=$(node -p "require('./coverage/coverage-summary.json').total.lines.pct" 2>/dev/null || echo "0")
  if (( $(echo "$COVERAGE < 70" | bc -l 2>/dev/null || echo "0") )); then
    echo "âš ï¸ Warning: Test coverage is below 70% ($COVERAGE%)"
    echo "Consider adding more tests before committing."
  fi
fi

# ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å“è³ªãƒã‚§ãƒƒã‚¯æº–å‚™
echo ""
echo "ğŸ’¡ Reminder: Write meaningful commit messages following conventional commits:"
echo "   - feat: new feature"
echo "   - fix: bug fix"
echo "   - docs: documentation"
echo "   - chore: maintenance"
echo ""

echo "${GREEN}âœ… Code check completed! We have passed the quality standards.${RESET}"
echo "${CYAN}Your commitment to quality is appreciated! ğŸ™${RESET}"