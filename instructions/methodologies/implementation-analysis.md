# 実装前分析プロトコル

すべての実装・コード変更タスクで必須実行

## Phase 1: 要求分析

□ Issue/要求から入力→処理→出力を抽出
□ TodoWriteツールで全作業項目を登録
□ 不明点があればこの場で質問（決定事項はIssueに記録）
□ 類似機能の既存実装を調査
✅出力: Issue記録「要求分析完了：[主要機能X個、決定事項]」

## Phase 2: 影響範囲特定

□ find_symbol で変更対象（関数/クラス/型/インターフェース）を特定
□ exportされた型・ジェネリクスも含めて追跡
□ find_referencing_symbols で参照元を網羅
□ grep/search_for_pattern で文字列使用も確認（テスト含む）
□ package.json と @types/* で外部型依存を確認
✅出力: Issue記録「影響範囲：[ファイルX個、型Y個、関数Z個]」

## Phase 3: 設計と計画

□ エラーハンドリング方針決定
□ 型安全性確保方法決定（型推論、ジェネリクス活用）
□ 必要十分なテストケース設計（価値あるテストのみ）
□ 実装順序の決定（小単位分割）
✅出力: Issue記録「設計完了、次ステップ：[具体的タスク名]」

## Phase 4: 段階的実装

□ 小単位での実装（1機能=1コミット）
□ 各単位でテスト実行・通過確認
□ TodoWrite更新
✅出力: Issue記録「Phase4進行中：[完了タスク]、次：[次のタスク]」

## Phase 5: エージェント品質検証

□ コードレビューエージェント実行
□ テスト品質エージェント実行（価値と保守性重視）
□ セキュリティエージェント実行
□ 指摘事項の対応
✅出力: Issue記録「品質検証完了、全エージェント承認」

## Issue記録ルール

- 進捗記録は再開可能な形式で記載
- 「Phase X完了、次は[具体的タスク]から開始」
- 質問と回答の要約、決定事項を明記
- 中断時点で何をすべきか明確に記載

## エージェント依頼文テンプレート

### コードレビュー用
```
CLAUDE.md を読み、深層思考で進めてください。
ゆっくりでいいので、常に質を優先して一度で完璧に答えるという基本原則を厳守。
私の依頼を入念に分析し、僅かな不明点でもあれば質問すること。
適当な思考・出力は信頼と価値を地に落とします。
求めてるのは速さではなく質。急がず、丁寧な仕事が最終的な効率を最大化します。
深層思考で意図を分析、200%の価値を提供して。
私は適当か否かを常に見てます。

可読性、保守性、パフォーマンス、セキュリティの観点から厳格にレビューしてください。
```

### テスト検証用
```
CLAUDE.md を読み、深層思考で進めてください。
ゆっくりでいいので、常に質を優先して一度で完璧に答えるという基本原則を厳守。
私の依頼を入念に分析し、僅かな不明点でもあれば質問すること。
適当な思考・出力は信頼と価値を地に落とします。
求めてるのは速さではなく質。急がず、丁寧な仕事が最終的な効率を最大化します。
深層思考で意図を分析、200%の価値を提供して。
私は適当か否かを常に見てます。

テストの価値と保守性を最重視してください。価値あるテストとは、実際のバグを防ぎ、仕様を明確にし、リファクタリングの安全網となるものです。カバレッジは副次的指標として扱ってください。
```

### セキュリティ検証用
```
CLAUDE.md を読み、深層思考で進めてください。
ゆっくりでいいので、常に質を優先して一度で完璧に答えるという基本原則を厳守。
私の依頼を入念に分析し、僅かな不明点でもあれば質問すること。
適当な思考・出力は信頼と価値を地に落とします。
求めてるのは速さではなく質。急がず、丁寧な仕事が最終的な効率を最大化します。
深層思考で意図を分析、200%の価値を提供して。
私は適当か否かを常に見てます。

OWASP Top 10、入力検証、認証認可、データ保護の観点で徹底的にチェックしてください。
```

## 実装手法の詳細

### 型解決と依存関係

- TypeScript/JavaScriptの場合
  - exportされた型、インターフェース、type aliasを追跡
  - ジェネリクス型パラメータの使用箇所を確認
  - @types/* パッケージの型定義を確認
  - 型推論が働く箇所の明示的な型付けを検討

### 小単位実装の原則

- 1つの論理的な変更 = 1コミット
- 各コミットでテストが通る状態を維持
- コミットメッセージは変更の意図を明確に記載
- 大きな変更は段階的にリファクタリング

### テストの価値判断基準

1. **バグ防止力**：実際に起こりうるバグを防げるか
2. **仕様明確化**：コードの意図を明確に示すか
3. **リファクタリング安全性**：変更時の安全網となるか
4. **保守性**：テスト自体が理解しやすく変更しやすいか

### 進捗管理と再開可能性

- TodoWriteで現在のタスクを常に最新化
- Issue記録は「どこまで完了し、次に何をすべきか」を明記
- 中断時は必ず「次のアクション」を記載
- 決定事項は箇条書きで整理