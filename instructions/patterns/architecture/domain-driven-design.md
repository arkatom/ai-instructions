# Domain-Driven Design (DDD)

## What
ドメインエキスパートと開発者が共通言語を用いて、複雑なビジネスドメインをソフトウェアにモデル化する設計手法。技術ではなくビジネスを中心に据える。

## Why
- 複雑なビジネスルールを正確にコードで表現
- ドメインエキスパートと開発者の認識齟齬を防ぐ
- ビジネスの変化に柔軟に対応できる設計
- コードがビジネスを語る（自己文書化）

## Core Principles

### 1. ユビキタス言語
- ドメインエキスパートと開発者が共有する共通言語
- コード、会話、ドキュメント全てで一貫して使用
- 技術用語ではなくビジネス用語を使用

### 2. 境界づけられたコンテキスト (Bounded Context)
- ドメインモデルが適用される明確な境界
- 各コンテキストは独自のユビキタス言語を持つ
- コンテキスト間の関係を明示的に定義

### 3. 戦略的設計
- **コアドメイン**: 競争優位性の源泉（最重要）
- **サポートドメイン**: コアを支える重要機能
- **汎用ドメイン**: 一般的な機能（外部調達可）

### 4. 戦術的設計パターン
- **エンティティ**: 識別子を持つオブジェクト
- **値オブジェクト**: 不変で識別子を持たない
- **アグリゲート**: 整合性境界の単位
- **リポジトリ**: アグリゲートの永続化
- **ドメインサービス**: エンティティに属さないビジネスロジック
- **ドメインイベント**: ビジネス上の出来事

## Best Practices

1. **ドメインエキスパートとの継続的な対話**
   - 定期的なモデリングセッション
   - ユビキタス言語の継続的な洗練

2. **アグリゲート設計**
   - 小さく保つ（1つのトランザクション境界）
   - ルートエンティティ経由でのみアクセス
   - 不変条件を常に満たす

3. **値オブジェクトの活用**
   - プリミティブ型の代わりに使用（Email, Money等）
   - ビジネスルールをカプセル化
   - 不変性を保証

4. **ドメインイベントの活用**
   - システム間の疎結合
   - イベントソーシングへの発展
   - 監査ログの自然な実現

5. **コンテキストマップの作成**
   - コンテキスト間の関係を可視化
   - 統合パターンの明確化（共有カーネル、顧客/供給者等）

## Simple Example

```pseudocode
// 値オブジェクト
ValueObject Money {
  amount: number
  currency: string
  
  add(other: Money) {
    // 通貨チェック、計算ロジック
  }
}

// エンティティ
Entity Order {
  id: OrderId
  items: OrderItem[]
  totalAmount: Money
  
  addItem(product, quantity) {
    // ビジネスルール検証
    // イベント発行: ItemAdded
  }
}

// アグリゲート
Aggregate OrderAggregate {
  root: Order
  
  // 外部からはルート経由でのみアクセス
  placeOrder() {
    // 不変条件の確認
    // OrderPlaced イベント発行
  }
}
```

## Anti-patterns

1. **貧血ドメインモデル**
   - ロジックのないデータ構造だけのエンティティ
   - ビジネスロジックがサービス層に漏れる

2. **過度に大きなアグリゲート**
   - パフォーマンス問題
   - 並行性の問題

3. **技術的な概念の混入**
   - SaveメソッドをEntityに実装
   - SQLクエリをドメイン層に記述

4. **ユビキタス言語の不統一**
   - 同じ概念に複数の名前
   - コードと会話で異なる用語

5. **境界の曖昧なコンテキスト**
   - 責務が不明確
   - モデルの汚染

## When to Use
- ビジネスロジックが複雑で変化が多い
- ドメインエキスパートとの協力が可能
- 長期的な保守・発展が必要
- チームがDDDを理解している

## When NOT to Use
- 単純なCRUDアプリケーション
- 技術的な問題が主体のシステム
- ドメインエキスパートが不在
- 短期的なプロジェクト

## Context Mapping Patterns
1. **共有カーネル**: 複数コンテキストで共有するコア
2. **顧客/供給者**: 上流/下流の関係
3. **順応者**: 下流が上流に合わせる
4. **腐敗防止層**: レガシーシステムとの境界
5. **公開ホストサービス**: 標準化されたプロトコル
6. **発行済み言語**: 文書化された交換形式